<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TWC | Disponibilità Ho.Re.Ca.</title>
  <style>
    :root{
      --bg:#0f1115; --panel:#171a21; --muted:#8b95a7; --text:#e6eaf2;
      --brand:#b48bff; --accent:#5be49b; --danger:#ff6b6b; --border:#252a34;
      --chip:#10161f;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    a{color:var(--brand);text-decoration:none}
    .container{max-width:1200px;margin:0 auto;padding:24px}

    /* Header */
    header{display:flex;align-items:center;gap:16px;margin-bottom:8px}
    .logo{height:140px;width:auto} /* leggermente più piccolo */
    .title{font-size:24px;font-weight:700}

    /* Contact banner */
    .contactbar{
      display:flex;flex-wrap:wrap;gap:16px;align-items:center;
      background:#121620;border:1px solid var(--border);border-radius:12px;
      padding:10px 12px;margin:10px 0 18px 0
    }
    .contact-item{display:flex;align-items:center;gap:8px;color:var(--text);font-size:14px}
    .contact-item svg{width:16px;height:16px;opacity:.9;flex:0 0 16px}
    .contact-item a{color:var(--text)}
    .contact-sep{width:1px;height:18px;background:var(--border);opacity:.8}

    /* Panel + toolbar */
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:12px}
    .toolbar{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:10px}
    .toolbar .field{display:flex;flex-direction:column;gap:6px}
    label{font-size:12px;color:var(--muted)}
    input,select{background:#0e1117;border:1px solid var(--border);
      color:var(--text);padding:10px 12px;border-radius:10px;font-size:14px}
    input::placeholder{color:#6b7280}

    /* Tabella (righe più “basse”) */
    .tablewrap{margin-top:12px;border:1px solid var(--border);border-radius:14px;overflow:hidden}
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{
      position:sticky;top:0;background:#0f141d;border-bottom:1px solid var(--border);
      text-align:left;font-size:12px;color:var(--muted);padding:8px
    }
    tbody td{
      padding:8px 10px; /* era 12px -> righe più compatte */
      border-bottom:1px solid var(--border);font-size:14px;line-height:1.25
    }
    tbody tr:hover{background:#131828}

    .qty-badge{
      display:inline-block;min-width:32px;text-align:center;padding:3px 8px;
      border-radius:999px;background:var(--chip);border:1px solid var(--border);font-size:13px
    }
    .qty-low{background:#231416;border-color:#3a1a1a;color:#ffb3b3}
    .badge{display:inline-block;padding:3px 10px;border-radius:999px;font-size:12px;border:1px solid var(--border)}
    .badge.no{background:#101a13;color:#a8f0c2;border-color:#244c36}
    .badge.yes{background:#241313;color:#ffbdbd;border-color:#4a1e1e}

    /* Footer della tabella (status + paginator) */
    .tablefooter{
      display:flex;justify-content:space-between;align-items:center;margin-top:12px;
      color:var(--muted);font-size:12px;gap:12px;flex-wrap:wrap
    }
    .status{font-size:12px;color:var(--muted)}

    /* Pagination moderna */
    .pagination{display:flex;align-items:center;gap:6px}
    .pager{
      background:#111520;border:1px solid var(--border);color:var(--text);
      padding:8px 10px;border-radius:10px;font-size:13px;cursor:pointer;
      transition:transform .05s ease, background .2s ease;
      min-width:36px;text-align:center
    }
    .pager:hover{background:#151a28}
    .pager.active{background:#1a2030;border-color:#343c4c;font-weight:700}
    .pager.disabled{opacity:.4;cursor:not-allowed}
    .dots{color:var(--muted);padding:0 4px}

    /* Site footer (legale) */
    .site-footer{
      margin:18px auto 0 auto;max-width:1200px;padding:16px 24px;color:#cbd5e1;
      font-size:12px;line-height:1.4;border-top:1px solid var(--border)
    }
    .site-footer small{display:block;color:var(--muted)}
    .site-footer .cols{display:grid;grid-template-columns:1fr;gap:8px}

    @media (max-width:900px){
      .toolbar{grid-template-columns:1fr 1fr}
      .hide-sm{display:none}
      .contact-sep{display:none}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <img id="logo" class="logo" alt="TWC Logo"
        src="https://shop.thewinecaveau.com/wp-content/uploads/2023/03/Logo-bianco-caveau-copia-2048x2048.png" />
      <div><div class="title">Disponibilità Ho.Re.Ca.</div></div>
    </header>

    <!-- Banner contatti -->
    <div class="contactbar" aria-label="Contatti TWC">
      <div class="contact-item">
        <!-- icona telefono -->
        <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M6.62 10.79a15.05 15.05 0 006.59 6.59l2.2-2.2a1 1 0 011.01-.24 11.36 11.36 0 003.56.57 1 1 0 011 1V20a1 1 0 01-1 1C10.4 21 3 13.6 3 4a1 1 0 011-1h3.5a1 1 0 011 1 11.36 11.36 0 00.57 3.56 1 1 0 01-.24 1.01l-2.21 2.22z"/></svg>
        <a href="tel:+393917011180">+39 391 701 1180</a>
      </div>
      <div class="contact-sep"></div>
      <div class="contact-item">
        <!-- icona mail -->
        <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M20 4H4a2 2 0 00-2 2v.4l10 6.25L22 6.4V6a2 2 0 00-2-2zm0 4.47l-8 5-8-5V18a2 2 0 002 2h12a2 2 0 002-2V8.47z"/></svg>
        <a href="mailto:info@thewinecaveau.com">info@thewinecaveau.com</a>
      </div>
    </div>

    <section class="panel">
      <div class="toolbar">
        <div class="field">
          <label for="q">Cerca (produttore / etichetta)</label>
          <input id="q" placeholder="Es. Dom Pérignon, Sassicaia, Barbaresco…" />
        </div>
        <div class="field">
          <label for="produttore">Produttore</label>
          <select id="produttore"><option value="">Tutti</option></select>
        </div>
        <div class="field">
          <label for="formato">Formato</label>
          <select id="formato"><option value="">Tutti</option></select>
        </div>
        <div class="field">
          <label for="riservato">Mostra riservati</label>
          <select id="riservato">
            <option value="no" selected>No</option>
            <option value="yes">Sì</option>
          </select>
        </div>
      </div>

      <div class="tablewrap">
        <table>
          <thead>
            <tr>
              <th></th>
              <th data-sort="produttore">Produttore</th>
              <th data-sort="etichetta">Etichetta</th>
              <th data-sort="formato" class="hide-sm">Formato</th>
              <th data-sort="box" class="hide-sm">Box</th>
              <th data-sort="quantità">Quantità</th>
              <th>Riservato</th>
            </tr>
          </thead>
          <tbody id="rows">
            <tr><td colspan="7" class="empty">Caricamento…</td></tr>
          </tbody>
        </table>
      </div>

      <div class="tablefooter">
        <div class="status" id="status">—</div>
        <div class="pagination" id="pagination" aria-label="Paginazione"></div>
      </div>
    </section>
  </div>

  <!-- Footer legale del sito -->
  <footer class="site-footer" role="contentinfo">
    <div class="cols">
      <div>© 2025 TWC S.R.L. — P.I. 07388060480</div>
      <div>TWC S.R.L. — via Parrocchia 7, 25020 FLERO (BS)</div>
      <small>
        Questo sito non fa parte del sito Facebook o Facebook Inc. Inoltre, questo sito NON è approvato da Facebook in alcun modo.
        FACEBOOK è un marchio registrato di FACEBOOK, Inc.
      </small>
      <small>
        *This Website is not a part of Facebook or Facebook Inc. Additionally, this site is NOT endorsed by Facebook in any way.
        FACEBOOK is a trademark of FACEBOOK Inc.
      </small>
    </div>
  </footer>

  <script>
  window.addEventListener('DOMContentLoaded', () => {
    const API_BASE = "https://api.thewinecaveau.com";
    const ENDPOINT  = API_BASE + '/availability';
    const PAGE_SIZE = 50;
    const LOW_STOCK_THRESHOLD = 6;
    const AUTO_REFRESH_MS = 30000;

    let data = [];
    let page = 0;
    let sort = { by: 'produttore', dir: 'asc' };

    const $ = (id)=>document.getElementById(id);
    const rows = $('rows');
    const status = $('status');
    const pagination = $('pagination');

    function fmtInt(n){ return Intl.NumberFormat('it-IT').format(n); }

    /* ===== Helpers quantità ===== */
    function normalizeQty(raw) {
      const s = (raw ?? "").toString().trim();
      if (!s) return "";
      if (/^su\s*richiesta$/i.test(s)) return "Su richiesta";
      if (/^(nan|null|none)$/i.test(s)) return "Su richiesta";
      return s;
    }
    function qtyNumber(raw) {
      const s = normalizeQty(raw);
      const n = Number(s.replace(",", "."));
      return Number.isFinite(n) ? n : null;
    }
    function formatQuantita(raw) {
      const s = normalizeQty(raw);
      if (!s) return "—";
      const n = Number(s.replace(",", "."));
      return Number.isFinite(n) ? String(n) : s;
    }

    /* ===== Filtri, sort, paging ===== */
    function applyFilters(src){
      const q = $('q').value.trim().toLowerCase();
      const p = $('produttore').value;
      const f = $('formato').value;
      const showReserved = $('riservato').value === 'yes';
      return src.filter(r=>{
        if(!showReserved && r.riservato === 'YES') return false;
        if(p && r.produttore !== p) return false;
        if(f && r.formato !== f) return false;
        if(q){
          const hay = (r.produttore + ' ' + r.etichetta).toLowerCase();
          if(!hay.includes(q)) return false;
        }
        return true;
      });
    }

    function sortData(arr){
      const {by,dir} = sort;
      const s = [...arr].sort((a,b)=>{
        if (by === 'quantità') {
          const na = qtyNumber(a["quantità"] ?? a.quantita);
          const nb = qtyNumber(b["quantità"] ?? b.quantita);
          if (na === null && nb === null) {
            const sa = normalizeQty(a["quantità"] ?? a.quantita).toLowerCase();
            const sb = normalizeQty(b["quantità"] ?? b.quantita).toLowerCase();
            if (sa<sb) return -1; if (sa>sb) return 1; return 0;
          }
          if (na === null) return 1;
          if (nb === null) return -1;
          return na - nb;
        }
        const va = (a[by] ?? '').toString().toLowerCase();
        const vb = (b[by] ?? '').toString().toLowerCase();
        if(va<vb) return -1; if(va>vb) return 1; return 0;
      });
      return dir==='asc'? s : s.reverse();
    }

    function build
