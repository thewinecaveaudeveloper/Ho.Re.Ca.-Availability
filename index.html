<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TWC | Disponibilità Ho.Re.Ca.</title>
  <style>
    :root{
      --bg:#0f1115; --panel:#171a21; --muted:#8b95a7; --text:#e6eaf2;
      --brand:#b48bff; --accent:#5be49b; --danger:#ff6b6b; --border:#252a34;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    a{color:var(--brand)}
    .container{max-width:1200px;margin:0 auto;padding:24px}
    header{display:flex;align-items:center;gap:16px;margin-bottom:16px}
    .logo{height:100px;width:auto}
    .title{font-size:24px;font-weight:700}
    .sub{color:var(--muted);font-size:12px}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:12px}
    .toolbar{display:grid;grid-template-columns:1fr 1fr 1fr 1fr auto;gap:10px}
    .toolbar .field{display:flex;flex-direction:column;gap:6px}
    label{font-size:12px;color:var(--muted)}
    input,select,button{background:#0e1117;border:1px solid var(--border);
      color:var(--text);padding:10px 12px;border-radius:10px;font-size:14px}
    input::placeholder{color:#6b7280}
    button{cursor:pointer}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;
      border-radius:12px;border:1px solid var(--border);background:#121620}
    .btn.primary{background:var(--brand);border-color:transparent;color:#1d1038}
    .btn.success{background:var(--accent);border-color:transparent;color:#052b1a}
    .btn.ghost{background:#0e1117}
    .tablewrap{margin-top:12px;border:1px solid var(--border);border-radius:14px;overflow:hidden}
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{position:sticky;top:0;background:#0f141d;border-bottom:1px solid var(--border);
      text-align:left;font-size:12px;color:var(--muted);padding:10px}
    tbody td{padding:12px;border-bottom:1px solid var(--border);font-size:14px}
    tbody tr:hover{background:#131828}
    .qty-badge{display:inline-block;min-width:36px;text-align:center;padding:4px 8px;
      border-radius:999px;background:#10161f;border:1px solid var(--border)}
    .qty-low{background:#231416;border-color:#3a1a1a;color:#ffb3b3}
    .badge{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;border:1px solid var(--border)}
    .badge.no{background:#101a13;color:#a8f0c2;border-color:#244c36}
    .badge.yes{background:#241313;color:#ffbdbd;border-color:#4a1e1e}
    .footer{display:flex;justify-content:space-between;align-items:center;margin-top:12px;
      color:var(--muted);font-size:12px}
    .pagination{display:flex;gap:8px}
    .empty{padding:28px;color:var(--muted);text-align:center}
    .status{font-size:12px;color:var(--muted)}
    @media (max-width:900px){
      .toolbar{grid-template-columns:1fr 1fr}
      .hide-sm{display:none}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <!-- ✅ Logo aggiornato con URL esterno -->
      <img id="logo" class="logo" alt="TWC Logo"
        src="https://shop.thewinecaveau.com/wp-content/uploads/2023/03/Logo-bianco-caveau-copia-2048x2048.png" />
      <div>
        <div class="title">Disponibilità Ho.Re.Ca.</div>
        <div class="sub">Vista aggiornata · Solo voci non riservate di default</div>
      </div>
    </header>

    <section class="panel">
      <div class="toolbar">
        <div class="field">
          <label for="q">Cerca (produttore / etichetta)</label>
          <input id="q" placeholder="Es. Dom Pérignon, Sassicaia, Barbaresco…" />
        </div>
        <div class="field">
          <label for="produttore">Produttore</label>
          <select id="produttore"><option value="">Tutti</option></select>
        </div>
        <div class="field">
          <label for="formato">Formato</label>
          <select id="formato"><option value="">Tutti</option></select>
        </div>
        <div class="field">
          <label for="riservato">Mostra riservati</label>
          <select id="riservato">
            <option value="no" selected>No</option>
            <option value="yes">Sì</option>
          </select>
        </div>
        <div class="field" style="align-self:end;display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
          <button id="refresh" class="btn ghost">Aggiorna</button>
          <button id="export" class="btn success">Esporta CSV</button>
        </div>
      </div>

      <div class="tablewrap">
        <table>
          <thead>
            <tr>
              <th></th>
              <th data-sort="produttore">Produttore</th>
              <th data-sort="etichetta">Etichetta</th>
              <th data-sort="formato" class="hide-sm">Formato</th>
              <th data-sort="box" class="hide-sm">Box</th>
              <th data-sort="quantità">Quantità</th>
              <th>Riservato</th>
            </tr>
          </thead>
          <tbody id="rows">
            <tr><td colspan="7" class="empty">Caricamento…</td></tr>
          </tbody>
        </table>
      </div>
      <div class="footer">
        <div class="status" id="status">—</div>
        <div class="pagination">
          <button class="btn" id="prev">‹ Precedente</button>
          <button class="btn" id="next">Successivo ›</button>
        </div>
      </div>
    </section>
  </div>

  <script>
  window.addEventListener('DOMContentLoaded', () => {

    const API_BASE = "https://api.thewinecaveau.com";
    const ENDPOINT  = API_BASE + '/availability';
    const PAGE_SIZE = 50;
    const LOW_STOCK_THRESHOLD = 6;
    const AUTO_REFRESH_MS = 30000;

    let data = [];
    let page = 0;
    let sort = { by: 'produttore', dir: 'asc' };

    const el = (id)=>document.getElementById(id);
    const rows = el('rows');
    const status = el('status');

    function fmtInt(n){ return Intl.NumberFormat('it-IT').format(n); }

    function applyFilters(src){
      const q = el('q').value.trim().toLowerCase();
      const p = el('produttore').value;
      const f = el('formato').value;
      const showReserved = el('riservato').value === 'yes';
      return src.filter(r=>{
        if(!showReserved && r.riservato === 'YES') return false;
        if(p && r.produttore !== p) return false;
        if(f && r.formato !== f) return false;
        if(q){
          const hay = (r.produttore + ' ' + r.etichetta).toLowerCase();
          if(!hay.includes(q)) return false;
        }
        return true;
      });
    }

    function sortData(arr){
      const {by,dir} = sort;
      const s = [...arr].sort((a,b)=>{
        const va = (a[by] ?? '').toString().toLowerCase();
        const vb = (b[by] ?? '').toString().toLowerCase();
        if(va<vb) return -1; if(va>vb) return 1; return 0;
      });
      return dir==='asc'? s : s.reverse();
    }

    function paginate(arr){
      const start = page*PAGE_SIZE;
      return arr.slice(start, start+PAGE_SIZE);
    }

    function render(){
      const filtered = applyFilters(data);
      const sorted   = sortData(filtered);
      const pageData = paginate(sorted);
      rows.innerHTML = '';
      if(pageData.length===0){
        rows.innerHTML = '<tr><td colspan="7" class="empty">Nessun risultato</td></tr>';
      } else {
        for(const r of pageData){
          const low = (r.quantità ?? 0) <= LOW_STOCK_THRESHOLD;
          rows.insertAdjacentHTML('beforeend', `
            <tr>
              <td></td>
              <td>${r.produttore}</td>
              <td>${r.etichetta}</td>
              <td class="hide-sm">${r.formato ?? ''}</td>
              <td class="hide-sm">${r.box ?? ''}</td>
              <td><span class="qty-badge ${low?'qty-low':''}">${fmtInt(r.quantità ?? 0)}</span></td>
              <td>
                ${r.riservato==='YES' ? '<span class="badge yes">YES</span>' : '<span class="badge no">NO</span>'}
              </td>
            </tr>
          `);
        }
      }
      const total = filtered.length;
      const from = Math.min(page*PAGE_SIZE+1, total);
      const to = Math.min((page+1)*PAGE_SIZE, total);
      status.textContent = total ? `${from}–${to} di ${fmtInt(total)} risultati` : '0 risultati';
    }

    function unique(list, key){
      const set = new Set(list.map(x=>x[key]).filter(Boolean));
      return Array.from(set).sort();
    }

    function populateFilters(){
      const ps = unique(data, 'produttore');
      const fs = unique(data, 'formato');
      const prodSel = el('produttore');
      const formSel = el('formato');
      prodSel.innerHTML = '<option value="">Tutti</option>' + ps.map(x=>`<option>${x}</option>`).join('');
      formSel.innerHTML = '<option value="">Tutti</option>' + fs.map(x=>`<option>${x}</option>`).join('');
    }

    async function fetchData(){
      console.log("▶ Chiamata API:", ENDPOINT);
      rows.innerHTML = '<tr><td colspan="7" class="empty">Caricamento…</td></tr>';
      try{
        const showReserved = el('riservato').value === 'yes';
        const params = new URLSearchParams();
        if(showReserved) params.set('include_reserved','true');
        const url = ENDPOINT + (params.toString()? ('?'+params.toString()):'');
        const r = await fetch(url, {cache:'no-store'});
        if(!r.ok) throw new Error('HTTP '+r.status);
        data = await r.json();
        populateFilters();
        page=0; render();
      }catch(e){
        console.error("Errore API:", e);
        rows.innerHTML = `<tr><td colspan="7" class="empty">Errore di caricamento: ${e.message}</td></tr>`;
      }
    }

    // Eventi e refresh automatico
    el('q').addEventListener('input', ()=>{ page=0; render(); });
    el('produttore').addEventListener('change', ()=>{ page=0; render(); });
    el('formato').addEventListener('change', ()=>{ page=0; render(); });
    el('riservato').addEventListener('change', ()=>{ fetchData(); });
    el('refresh').addEventListener('click', fetchData);
    el('prev').addEventListener('click', ()=>{ if(page>0){page--; render();}});
    el('next').addEventListener('click', ()=>{ const filtered=applyFilters(data); if((page+1)*PAGE_SIZE<filtered.length){page++; render();}});

    document.querySelectorAll('th[data-sort]').forEach(th=>{
      th.style.cursor='pointer';
      th.addEventListener('click',()=>{
        const by = th.getAttribute('data-sort');
        if(sort.by===by){ sort.dir = (sort.dir==='asc'?'desc':'asc'); }
        else { sort.by=by; sort.dir='asc'; }
        render();
      });
    });

    function toCSV(){
      const header = ['produttore','etichetta','formato','box','quantità','riservato'];
      const escape = v => ('"'+String(v??'').replaceAll('"','""')+'"');
      const lines = [header.join(',')];
      const filtered = sortData(applyFilters(data));
      for(const r of filtered){
        lines.push([r.produttore,r.etichetta,r.formato||'',r.box||'',r.quantità||0,r.riservato].map(escape).join(','));
      }
      return lines.join('\n');
    }

    el('export').addEventListener('click',()=>{
      const csv = toCSV(data);
      const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'disponibilita.csv';
      document.body.appendChild(a); a.click(); a.remove();
    });

    setInterval(fetchData, AUTO_REFRESH_MS);
    fetchData();
  });
  </script>
</body>
</html>
