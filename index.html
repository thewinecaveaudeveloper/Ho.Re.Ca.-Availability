<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>TWC | Disponibilità Ho.Re.Ca.</title>
  <style>
    :root{
      --bg:#0f1115; --panel:#171a21; --muted:#8b95a7; --text:#e6eaf2;
      --brand:#b48bff; --accent:#5be49b; --danger:#ff6b6b; --border:#252a34; --chip:#10161f;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    a{color:var(--brand);text-decoration:none}
    img{max-width:100%;display:block}
    .container{max-width:1200px;margin:0 auto;padding:16px clamp(12px,4vw,24px);padding-bottom:24px}

    /* Header */
    header{display:flex;align-items:center;gap:16px;margin-bottom:8px}
    .logo{height:120px;width:auto}
    .title{font-size:clamp(20px,3.6vw,28px);font-weight:800;letter-spacing:.2px}

    /* Contact banner */
    .contactbar{
      display:flex;flex-wrap:wrap;gap:14px;align-items:center;
      background:#121620;border:1px solid var(--border);border-radius:12px;
      padding:10px 12px;margin:10px 0 18px 0
    }
    .contact-item{display:flex;align-items:center;gap:8px;color:var(--text);font-size:14px;line-height:1}
    .contact-item svg{width:16px;height:16px;opacity:.9;flex:0 0 16px}
    .contact-item a{color:var(--text)}
    .contact-sep{width:1px;height:18px;background:var(--border);opacity:.8}

    /* Panel + toolbar */
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:12px}
    .toolbar{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (min-width:880px){ .toolbar{grid-template-columns:1fr 1fr 1fr 1fr} }
    .field{display:flex;flex-direction:column;gap:6px}
    label{font-size:12px;color:var(--muted)}
    input,select{
      background:#0e1117;border:1px solid var(--border);color:var(--text);
      padding:12px 12px;border-radius:10px;font-size:15px;min-height:44px
    }
    input::placeholder{color:#6b7280}

    /* Tabella desktop */
    .tablewrap{margin-top:12px;border:1px solid var(--border);border-radius:14px;overflow:hidden}
    table{width:100%;border-collapse:collapse;border-spacing:0;table-layout:fixed}
    thead th{
      background:#0f141d;border-bottom:1px solid var(--border);
      text-align:left;font-size:12px;color:var(--muted);padding:10px
    }
    /* 5 colonne: Produttore | Etichetta | Formato | Quantità | Riservato */
    thead th:nth-child(1){width:30%}
    thead th:nth-child(2){width:36%}
    thead th:nth-child(3){width:14%}
    thead th:nth-child(4){width:12%}
    thead th:nth-child(5){width:8%}

    /* evita l'a-capo dentro il badge quantità */
    .qty-badge{ 
      display:inline-block;
      min-width:32px;
      text-align:center;
      padding:3px 8px;
      border-radius:999px;
      background:var(--chip);
      border:1px solid var(--border);
      font-size:13px;
      white-space: nowrap;   /* ← aggiunto */
    }

    tbody td{padding:9px 10px;border-bottom:1px solid var(--border);font-size:14px;line-height:1.25;vertical-align:middle}
    tbody tr:hover{background:#131828}
    .qty-badge{display:inline-block;min-width:32px;text-align:center;padding:3px 8px;border-radius:999px;background:var(--chip);border:1px solid var(--border);font-size:13px}
    .qty-low{background:#231416;border-color:#3a1a1a;color:#ffb3b3}
    .badge{display:inline-block;padding:3px 10px;border-radius:999px;font-size:12px;border:1px solid var(--border)}
    .badge.no{background:#101a13;color:#a8f0c2;border-color:#244c36}
    .badge.yes{background:#241313;color:#ffbdbd;border-color:#4a1e1e}
    .empty{padding:28px;color:var(--muted);text-align:center}

    /* Mobile: card view */
    @media (max-width:640px){
      thead{display:none}
      table, tbody, tr, td{display:block;width:100%}
      tbody tr{border-bottom:1px solid var(--border);padding:10px 10px}
      tbody td{border:0;padding:4px 0}
      tbody td[data-th]{display:flex;justify-content:space-between;gap:10px}
      tbody td[data-th]::before{
        content:attr(data-th);
        color:var(--muted);font-size:12px;flex:0 0 auto;min-width:110px
      }
      .qty-badge{min-width:46px}
    }

    /* Footer tabella */
    .tablefooter{
      display:flex;justify-content:space-between;align-items:center;margin-top:12px;
      color:var(--muted);font-size:12px;gap:12px;flex-wrap:wrap
    }
    .status{font-size:12px;color:var(--muted)}
    .pagination{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
    .pager{
      background:#111520;border:1px solid var(--border);color:var(--text);
      padding:10px 12px;border-radius:10px;font-size:15px;cursor:pointer;
      min-width:40px;min-height:40px;text-align:center
    }
    .pager:hover{background:#151a28}
    .pager.active{background:#1a2030;border-color:#343c4c;font-weight:700}
    .pager.disabled{opacity:.45;cursor:not-allowed}
    .dots{color:var(--muted);padding:0 4px}

    /* Footer legale */
    .site-footer{
      margin:18px auto 0 auto;max-width:1200px;padding:16px clamp(12px,4vw,24px);
      color:#cbd5e1;font-size:12px;line-height:1.4;border-top:1px solid var(--border)
    }
    .site-footer small{display:block;color:var(--muted)}
    .site-footer .cols{display:grid;grid-template-columns:1fr;gap:8px}

    @media (max-width:880px){
      .logo{height:90px}
      .contact-sep{display:none}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <img id="logo" class="logo" alt="TWC Logo"
        src="https://shop.thewinecaveau.com/wp-content/uploads/2023/03/Logo-bianco-caveau-copia-2048x2048.png" />
      <div><div class="title">Disponibilità Ho.Re.Ca.</div></div>
    </header>

    <div class="contactbar" aria-label="Contatti TWC">
      <div class="contact-item">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M6.62 10.79a15.05 15.05 0 006.59 6.59l2.2-2.2a1 1 0 011.01-.24 11.36 11.36 0 003.56.57 1 1 0 011 1V20a1 1 0 01-1 1C10.4 21 3 13.6 3 4a1 1 0 011-1h3.5a1 1 0 011 1 11.36 11.36 0 00.57 3.56 1 1 0 01-.24 1.01l-2.21 2.22z"/></svg>
        <a href="tel:+393917011180">+39 391 701 1180</a>
      </div>
      <div class="contact-sep"></div>
      <div class="contact-item">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4a2 2 0 00-2 2v.4l10 6.25L22 6.4V6a2 2 0 00-2-2zm0 4.47l-8 5-8-5V18a2 2 0 002 2h12a2 2 0 002-2V8.47z"/></svg>
        <a href="mailto:info@thewinecaveau.com">info@thewinecaveau.com</a>
      </div>
    </div>

    <section class="panel">
      <div class="toolbar">
        <div class="field">
          <label for="q">Cerca (produttore / etichetta)</label>
          <input id="q" placeholder="Es. Dom Pérignon, Sassicaia, Barbaresco…" />
        </div>
        <div class="field">
          <label for="produttore">Produttore</label>
          <select id="produttore"><option value="">Tutti</option></select>
        </div>
        <div class="field">
          <label for="formato">Formato</label>
          <select id="formato"><option value="">Tutti</option></select>
        </div>
        <div class="field">
          <label for="riservato">Mostra riservati</label>
          <select id="riservato">
            <option value="no" selected>No</option>
            <option value="yes">Sì</option>
          </select>
        </div>
      </div>

      <div class="tablewrap">
        <table>
          <thead>
            <tr>
              <th data-sort="produttore">Produttore</th>
              <th data-sort="etichetta">Etichetta</th>
              <th data-sort="formato">Formato</th>
              <th data-sort="quantità">Quantità</th>
              <th>Riservato</th>
            </tr>
          </thead>
          <tbody id="rows">
            <tr><td colspan="5" class="empty">Caricamento…</td></tr>
          </tbody>
        </table>
      </div>

      <div class="tablefooter">
        <div class="status" id="status">—</div>
        <div class="pagination" id="pagination" aria-label="Paginazione"></div>
      </div>
    </section>
  </div>

  <footer class="site-footer">
    <div class="cols">
      <div>© 2025 TWC S.R.L. — P.I. 07388060480</div>
      <div>TWC S.R.L. — via Parrocchia 7, 25020 FLERO (BS)</div>
      <small>Questo sito non fa parte del sito Facebook o Facebook Inc. Inoltre, questo sito NON è approvato da Facebook in alcun modo. FACEBOOK è un marchio registrato di FACEBOOK, Inc.</small>
      <small>*This Website is not a part of Facebook or Facebook Inc. Additionally, this site is NOT endorsed by Facebook in any way. FACEBOOK is a trademark of FACEBOOK Inc.</small>
    </div>
  </footer>

  <script>
  (function(){
    const API_BASE = "https://api.thewinecaveau.com";
    const ENDPOINT = API_BASE + "/availability";
    const LOW_STOCK_THRESHOLD = 6;
    const AUTO_REFRESH_MS = 30000;
    const pageSize = ()=> (matchMedia("(max-width:640px)").matches ? 20 : 50);

    let data = [], page = 0, sort = {by:"produttore",dir:"asc"};
    const $ = id=>document.getElementById(id);
    let rows, pagination;

    const labels = {
      produttore:"Produttore", etichetta:"Etichetta", formato:"Formato", quantita:"Quantità", riservato:"Riservato"
    };

    function fmtInt(n){ return Intl.NumberFormat("it-IT").format(n); }
    function normalizeQty(raw){const s=(raw??"").toString().trim();if(!s)return"";if(/^su\s*richiesta$/i.test(s))return"Su richiesta";if(/^(nan|null|none)$/i.test(s))return"Su richiesta";return s;}
    function qtyNumber(raw){const s=normalizeQty(raw);const n=Number(s.replace(",","."));return Number.isFinite(n)?n:null;}
    function formatQuantita(raw){const s=normalizeQty(raw);if(!s)return"—";const n=Number(s.replace(",","."));return Number.isFinite(n)?String(n):s;}

    function applyFilters(src){
      const q=$("q").value.trim().toLowerCase(),p=$("produttore").value,f=$("formato").value;
      const showReserved=$("riservato").value==="yes";
      return src.filter(r=>{
        if(!showReserved&&r.riservato==="YES")return false;
        if(p&&r.produttore!==p)return false;
        if(f&&r.formato!==f)return false;
        if(q&&!((r.produttore+" "+r.etichetta).toLowerCase().includes(q)))return false;
        return true;
      });
    }

    function sortData(arr){
      const {by,dir}=sort;
      const s=[...arr].sort((a,b)=>{
        if(by==="quantità"){
          const na=qtyNumber(a["quantità"]??a.quantita),nb=qtyNumber(b["quantità"]??b.quantita);
          if(na===null&&nb===null){const sa=normalizeQty(a["quantità"]??a.quantita).toLowerCase(),sb=normalizeQty(b["quantità"]??b.quantita).toLowerCase();if(sa<sb)return-1;if(sa>sb)return 1;return 0;}
          if(na===null)return 1;if(nb===null)return-1;return na-nb;
        }
        const va=(a[by]??"").toString().toLowerCase(),vb=(b[by]??"").toString().toLowerCase();
        if(va<vb)return-1;if(va>vb)return 1;return 0;
      });
      return dir==="asc"?s:s.reverse();
    }

    function buildPagination(total,current){
      const totalPages=Math.max(1,Math.ceil(total/pageSize()));
      const btn=(label,target,disabled=false,active=false)=>`<button class="pager ${disabled?'disabled':''} ${active?'active':''}" data-page="${target}" ${disabled?'disabled':''}>${label}</button>`;
      let html='';html+=btn('‹',current-1,current<=0);
      const maxButtons=7,lastIndex=totalPages-1;
      let start=Math.max(0,current-3),end=Math.min(totalPages,start+maxButtons);
      if(end-start<maxButtons)start=Math.max(0,end-maxButtons);
      if(start>0){html+=btn('1',0,false,current===0);if(start>1)html+='<span class="dots">…</span>';}
      for(let i=start;i<end;i++){html+=btn(String(i+1),i,false,current===i);}
      if(end<totalPages){if(end<totalPages-1)html+='<span class="dots">…</span>';html+=btn(String(totalPages),lastIndex,false,current===lastIndex);}
      html+=btn('›',current+1,current>=lastIndex);
      $("pagination").innerHTML=html;
    }

    function paginate(arr){const start=page*pageSize();return arr.slice(start,start+pageSize());}
    function clampPage(total){const totalPages=Math.max(1,Math.ceil(total/pageSize()));if(page>=totalPages)page=totalPages-1;if(page<0)page=0;}

    function render(){
      const filtered=applyFilters(data),sorted=sortData(filtered);
      clampPage(sorted.length);const pageData=paginate(sorted);

      rows.innerHTML='';
      if(pageData.length===0){
        rows.innerHTML='<tr><td colspan="5" class="empty">Nessun risultato</td></tr>';
      }else{
        for(const r of pageData){
          const qRaw=r["quantità"]??r.quantita,qNum=qtyNumber(qRaw),qTxt=formatQuantita(qRaw),low=qNum!==null&&qNum<=LOW_STOCK_THRESHOLD;
          rows.insertAdjacentHTML('beforeend',`
            <tr>
              <td data-th="${labels.produttore}">${r.produttore}</td>
              <td data-th="${labels.etichetta}">${r.etichetta}</td>
              <td data-th="${labels.formato}">${r.formato??''}</td>
              <td data-th="${labels.quantita}"><span class="qty-badge ${low?'qty-low':''}">${qTxt}</span></td>
              <td data-th="${labels.riservato}">${r.riservato==='YES'?'<span class="badge yes">YES</span>':'<span class="badge no">NO</span>'}</td>
            </tr>`);
        }
      }
      const total=filtered.length,from=total?(page*pageSize()+1):0,to=Math.min((page+1)*pageSize(),total);
      $("status").textContent = total ? `${from}–${to} di ${fmtInt(total)} risultati` : '0 risultati';
      buildPagination(total,page);
    }

    function unique(list,key){const set=new Set(list.map(x=>x[key]).filter(Boolean));return Array.from(set).sort();}
    function populateFilters(){
      const ps=unique(data,'produttore'),fs=unique(data,'formato');
      $("produttore").innerHTML='<option value="">Tutti</option>'+ps.map(x=>`<option>${x}</option>`).join('');
      $("formato").innerHTML   ='<option value="">Tutti</option>'+fs.map(x=>`<option>${x}</option>`).join('');
    }

    function keyOf(r){return [r.produttore,r.etichetta,r.formato].join('||');}

    async function initialLoad(){
      rows.innerHTML = '<tr><td colspan="5" class="empty">Caricamento…</td></tr>';
      const showReserved=$("riservato").value==="yes";
      const params=new URLSearchParams(); if(showReserved) params.set("include_reserved","true");
      const url=ENDPOINT+(params.toString()?('?'+params.toString()):'');
      const r=await fetch(url,{cache:'no-store'}); if(!r.ok) throw new Error('HTTP '+r.status);
      data=await r.json();
      populateFilters(); render();
    }

    async function updateQuantities(){
      try{
        const showReserved=$("riservato").value==="yes";
        const params=new URLSearchParams(); if(showReserved) params.set("include_reserved","true");
        const url=ENDPOINT+(params.toString()?('?'+params.toString()):'');
        const r=await fetch(url,{cache:'no-store'}); if(!r.ok) throw new Error('HTTP '+r.status);
        const latest=await r.json();
        const map=new Map(latest.map(x=>[keyOf(x), x["quantità"]??x.quantita]));
        let changed=false;
        for(const row of data){
          const k=keyOf(row);
          if(map.has(k)){
            const newQ=map.get(k),oldQ=row["quantità"]??row.quantita;
            if(String(newQ)!==String(oldQ)){ if("quantità" in row) row["quantità"]=newQ; else row.quantita=newQ; changed=true; }
          }
        }
        if(changed) render();
      }catch(e){ console.warn("Auto-refresh fallito:", e.message); }
    }

    function wireUI(){
      $("q").addEventListener("input", ()=>{ page=0; render(); });
      $("produttore").addEventListener("change", ()=>{ page=0; render(); });
      $("formato").addEventListener("change", ()=>{ page=0; render(); });
      $("riservato").addEventListener("change", ()=>{ initialLoad(); });

      document.querySelectorAll("th[data-sort]").forEach(th=>{
        th.style.cursor='pointer';
        th.addEventListener("click",()=>{
          const by=th.getAttribute("data-sort");
          if(sort.by===by){ sort.dir = (sort.dir==='asc'?'desc':'asc'); }
          else { sort.by=by; sort.dir='asc'; }
          page=0; render();
        });
      });

      $("pagination").addEventListener("click",(e)=>{
        const btn=e.target.closest("button[data-page]"); if(!btn||btn.disabled) return;
        const target=parseInt(btn.dataset.page,10);
        if(Number.isFinite(target)){ page=target; render(); window.scrollTo({top:0,behavior:'smooth'}); }
      });

      matchMedia("(max-width:640px)").addEventListener("change", ()=>{ page=0; render(); });
    }

    function init(){
      rows=$("rows"); pagination=$("pagination");
      wireUI();
      initialLoad().catch(e=>{
        rows.innerHTML=`<tr><td colspan="5" class="empty">Errore di caricamento. Verifica connessione o riprova.</td></tr>`;
        console.error("Errore initialLoad:", e);
      });
      setInterval(updateQuantities, AUTO_REFRESH_MS);
    }

    if(document.readyState==="loading"){ document.addEventListener("DOMContentLoaded", init, {once:true}); }
    else { init(); }
  })();
  </script>
</body>
</html>
