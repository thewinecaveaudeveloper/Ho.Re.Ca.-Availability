<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>TWC | Disponibilità Ho.Re.Ca.</title>
  <style>
    :root{
      --bg:#0f1115; --panel:#171a21; --muted:#8b95a7; --text:#e6eaf2;
      --brand:#b48bff; --accent:#5be49b; --danger:#ff6b6b; --border:#252a34; --chip:#10161f;
      --btn:#222836; --btn-h:#293045;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    a{color:var(--brand);text-decoration:none}
    img{max-width:100%;display:block}
    .container{max-width:1200px;margin:0 auto;padding:16px clamp(12px,4vw,24px);padding-bottom:24px}

    /* Header */
    header{display:flex;align-items:center;gap:16px;margin-bottom:8px}
    .logo{height:120px;width:auto}
    .title{font-size:clamp(20px,3.6vw,28px);font-weight:800;letter-spacing:.2px}
    .header-row{display:flex;align-items:center;justify-content:space-between;width:100%}

    /* Contact banner */
    .contactbar{
      display:flex;flex-wrap:wrap;gap:14px;align-items:center;
      background:#121620;border:1px solid var(--border);border-radius:12px;
      padding:10px 12px;margin:10px 0 18px 0
    }
    .contact-left{display:flex;flex-wrap:wrap;gap:14px;align-items:center}
    .contact-actions{display:flex;gap:10px;margin-left:auto}
    .contact-item{display:flex;align-items:center;gap:8px;color:var(--text);font-size:14px;line-height:1}
    .contact-item svg{width:16px;height:16px;opacity:.9;flex:0 0 16px}
    .contact-item a{color:var(--text)}
    .contact-sep{width:1px;height:18px;background:var(--border);opacity:.8}

    .btn{
      appearance:none;border:1px solid var(--border);background:var(--btn);
      color:var(--text);padding:10px 14px;border-radius:10px;font-size:14px;
      cursor:pointer;transition:background .15s ease,border-color .15s ease,filter .15s ease,box-shadow .15s ease
    }
    .btn:hover{background:var(--btn-h)}
    .btn.primary{background:var(--brand);border-color:#ebc438;color:#0d0f15;font-weight:700}
    .btn.primary:hover{filter:brightness(0.95)}
    /* Call-to-action più visibile */
    .btn.cta{background:var(--accent);border-color:#2f7d59;color:#0d0f15;font-weight:800;box-shadow:0 6px 22px rgba(91,228,155,.2)}
    .btn.cta:hover{filter:brightness(0.95)}
    .btn.cta:focus{outline:2px solid #2f7d59;outline-offset:2px}

    /* Panel + toolbar */
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:12px}
    .toolbar{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (min-width:880px){ .toolbar{grid-template-columns:1fr 1fr 1fr 1fr} }
    .field{display:flex;flex-direction:column;gap:6px}
    label{font-size:12px;color:var(--muted)}
    input,select,textarea{
      background:#0e1117;border:1px solid var(--border);color:var(--text);
      padding:12px 12px;border-radius:10px;font-size:15px;min-height:44px
    }
    input::placeholder,textarea::placeholder{color:#6b7280}

    /* Tabella desktop */
    .tablewrap{margin-top:12px;border:1px solid var(--border);border-radius:14px;overflow:hidden}
    table{width:100%;border-collapse:collapse;border-spacing:0;table-layout:fixed}
    thead th{
      background:#0f141d;border-bottom:1px solid var(--border);
      text-align:left;font-size:12px;color:var(--muted);padding:10px
    }
    /* Produttore | Etichetta | Annata | Formato | Quantità | Prezzo | Riservato */
    thead th:nth-child(1){width:20%}
    thead th:nth-child(2){width:22%}
    thead th:nth-child(3){width:10%}
    thead th:nth-child(4){width:12%}
    thead th:nth-child(5){width:12%}
    thead th:nth-child(6){width:10%; text-align:right; font-variant-numeric: tabular-nums}
    thead th:nth-child(7){width:8%}

    tbody td{padding:9px 10px;border-bottom:1px solid var(--border);font-size:14px;line-height:1.25;vertical-align:middle}
    tbody tr:hover{background:#131828}
    .qty-badge{
      display:inline-block;min-width:32px;text-align:center;padding:3px 8px;border-radius:999px;
      background:var(--chip);border:1px solid var(--border);font-size:13px;white-space:nowrap;
    }
    .qty-low{background:#231416;border-color:#3a1a1a;color:#ffb3b3}
    .price{text-align:right;white-space:nowrap; font-variant-numeric: tabular-nums}
    .badge{display:inline-block;padding:3px 10px;border-radius:999px;font-size:12px;border:1px solid var(--border)}
    .badge.no{background:#101a13;color:#a8f0c2;border-color:#244c36}
    .badge.yes{background:#241313;color:#ffbdbd;border-color:#4a1e1e}
    .empty{padding:28px;color:var(--muted);text-align:center}

    /* Mobile: card view */
    @media (max-width:640px){
      .contactbar{gap:10px}
      .contact-actions{width:100%;justify-content:flex-start;margin-left:0}
      thead{display:none}
      table, tbody, tr, td{display:block;width:100%}
      tbody tr{border-bottom:1px solid var(--border);padding:10px 10px}
      tbody td{border:0;padding:4px 0}
      tbody td[data-th]{display:flex;justify-content:space-between;gap:10px}
      tbody td[data-th]::before{
        content:attr(data-th);
        color:var(--muted);font-size:12px;flex:0 0 auto;min-width:110px
      }
      .qty-badge{min-width:46px}
      .price{text-align:left}
    }

    /* Footer tabella */
    .tablefooter{
      display:flex;justify-content:space-between;align-items:center;margin-top:12px;
      color:var(--muted);font-size:12px;gap:12px;flex-wrap:wrap
    }
    .status{font-size:12px;color:var(--muted)}
    .pagination{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
    .pager{
      background:#111520;border:1px solid var(--border);color:var(--text);
      padding:10px 12px;border-radius:10px;font-size:15px;cursor:pointer;
      min-width:40px;min-height:40px;text-align:center
    }
    .pager:hover{background:#151a28}
    .pager.active{background:#1a2030;border-color:#343c4c;font-weight:700}
    .pager.disabled{opacity:.45;cursor:not-allowed}
    .dots{color:var(--muted);padding:0 4px}

    /* Footer legale */
    .site-footer{
      margin:18px auto 0 auto;max-width:1200px;padding:16px clamp(12px,4vw,24px);
      color:#cbd5e1;font-size:12px;line-height:1.4;border-top:1px solid var(--border)
    }
    .site-footer small{display:block;color:var(--muted)}
    .site-footer .cols{display:grid;grid-template-columns:1fr;gap:8px}

    /* Modal form */
    .modal-backdrop{
      position:fixed;inset:0;background:rgba(0,0,0,.55);
      display:none;align-items:center;justify-content:center;padding:20px;z-index:50
    }
    .modal{width:min(680px,100%);background:#121620;border:1px solid var(--border);border-radius:16px;padding:16px}
    .modal header{display:flex;align-items:center;justify-content:space-between;margin:0 0 10px 0}
    .modal h3{margin:0;font-size:18px}
    .modal .grid{display:grid;grid-template-columns:1fr;gap:10px}
    @media (min-width:680px){ .modal .grid{grid-template-columns:1fr 1fr} }
    .modal textarea{min-height:110px;resize:vertical}
    .modal .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:8px}
    .close-x{background:transparent;border:0;color:var(--muted);font-size:22px;cursor:pointer}
    .hint{font-size:12px;color:var(--muted)}

    /* Toast (verde e centrale) */
    .toast{
      position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);
      background:#0f141d;border:1px solid var(--border);color:var(--text);
      padding:12px 16px;border-radius:12px;font-size:15px;display:none;z-index:60;
      box-shadow:0 8px 28px rgba(0,0,0,.35);min-width:280px;text-align:center
    }
    .toast.success{background:var(--accent);border-color:#2f7d59;color:#0d0f15;font-weight:700}
    .toast.error{background:#3a1a1a;border-color:#4a1e1e;color:#ffbdbd}

    .err{color:#ffb3b3}
    .visually-hidden{position:absolute!important;height:1px;width:1px;overflow:hidden;clip:rect(1px,1px,1px,1px);white-space:nowrap}
    @media (max-width:880px){ .logo{height:90px} .contact-sep{display:none} }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <img id="logo" class="logo" alt="TWC Logo"
        src="https://shop.thewinecaveau.com/wp-content/uploads/2023/03/Logo-bianco-caveau-copia-2048x2048.png" />
      <div class="header-row">
        <div class="title">Disponibilità Ho.Re.Ca.</div>
        <button class="btn primary" id="adminBtn" type="button" aria-label="Area amministratore">Admin</button>
      </div>
    </header>

    <!-- Banner contatti -->
    <div class="contactbar" aria-label="Contatti TWC">
      <div class="contact-left">
        <div class="contact-item">
          <!-- Telefono -->
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M6.62 10.79a15.05 15.05 0 006.59 6.59l2.2-2.2a1 1 0 011.01-.24 11.36 11.36 0 003.56.57 1 1 0 011 1V20a1 1 0 01-1 1C10.4 21 3 13.6 3 4a1 1 0 011-1h3.5a1 1 0 011 1 11.36 11.36 0 00.57 3.56 1 1 0 01-.24 1.01l-2.21 2.22z"/></svg>
          <a href="tel:+393917011180">+39 391 701 1180</a>
        </div>
        <div class="contact-sep"></div>
        <div class="contact-item">
          <!-- Mail -->
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4a2 2 0 00-2 2v.4l10 6.25L22 6.4V6a2 2 0 00-2-2zm0 4.47l-8 5-8-5V18a2 2 0 002 2h12a2 2 0 002-2V8.47z"/></svg>
          <a href="mailto:info@thewinecaveau.com">info@thewinecaveau.com</a>
        </div>
        <div class="contact-sep"></div>
        <div class="contact-item">
          <!-- Sito -->
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a10 10 0 100 20 10 10 0 000-20zm6.93 8h-3.26A13.2 13.2 0 0014 4.36 8.02 8.02 0 0118.93 10zM12 4.06c.86 0 2.34 1.7 3.06 5.94H8.94C9.66 5.76 11.14 4.06 12 4.06zM5.07 10A8.02 8.02 0 0110 4.36 13.2 13.2 0 008.33 10H5.07zm0 4h3.26A13.2 13.2 0 0010 19.64 8.02 8.02 0 015.07 14zm6.93 5.94c-.86 0-2.34-1.7-3.06-5.94h6.12c-.72 4.24-2.2 5.94-3.06 5.94zM14 19.64A13.2 13.2 0 0015.67 14h3.26A8.02 8.02 0 0114 19.64z"/></svg>
          <a href="https://shop.thewinecaveau.com" target="_blank" rel="noopener">thewinecaveau.com</a>
        </div>
      </div>
      <div class="contact-actions">
        <button class="btn cta" id="openContactBtn" type="button" aria-label="Invia una richiesta di disponibilità">Invia richiesta</button>
      </div>
    </div>

    <!-- Pannello tabella/filtri -->
    <section class="panel">
      <div class="toolbar">
        <div class="field">
          <label for="q">Cerca (produttore / etichetta / annata)</label>
          <input id="q" placeholder="Es. Dom Pérignon, Sassicaia, 2018…" />
        </div>
        <div class="field">
          <label for="produttore">Produttore</label>
          <select id="produttore"><option value="">Tutti</option></select>
        </div>
        <div class="field">
          <label for="formato">Formato</label>
          <select id="formato"><option value="">Tutti</option></select>
        </div>
        <div class="field">
          <label for="riservato">Mostra riservati</label>
          <select id="riservato">
            <option value="no" selected>No</option>
            <option value="yes">Sì</option>
          </select>
        </div>
      </div>

      <div class="tablewrap">
        <table>
          <thead>
            <tr>
              <th data-sort="produttore">Produttore</th>
              <th data-sort="etichetta">Etichetta</th>
              <th data-sort="annata">Annata</th>
              <th data-sort="formato">Formato</th>
              <th data-sort="quantità">Quantità</th>
              <th data-sort="prezzo">Prezzo (iva incl.)</th>
              <th>Riservato</th>
            </tr>
          </thead>
          <tbody id="rows">
            <tr><td colspan="7" class="empty">Caricamento…</td></tr>
          </tbody>
        </table>
      </div>

      <div class="tablefooter">
        <div class="status" id="status">—</div>
        <div class="pagination" id="pagination" aria-label="Paginazione"></div>
      </div>
    </section>
  </div>

  <!-- Footer legale -->
  <footer class="site-footer">
    <div class="cols">
      <div>© 2025 TWC S.R.L. — P.I. 07388060480</div>
      <div>TWC S.R.L. — via Parrocchia 7, 25020 FLERO (BS)</div>
      <small>Questo sito non fa parte del sito Facebook o Facebook Inc. Inoltre, questo sito NON è approvato da Facebook in alcun modo. FACEBOOK è un marchio registrato di FACEBOOK, Inc.</small>
      <small>*This Website is not a part of Facebook or Facebook Inc. Additionally, this site is NOT endorsed by Facebook in any way. FACEBOOK is a trademark of FACEBOOK Inc.</small>
    </div>
  </footer>

  <!-- Modal Contatti -->
  <div class="modal-backdrop" id="contactModal" role="dialog" aria-modal="true" aria-labelledby="contactTitle">
    <div class="modal">
      <header>
        <h3 id="contactTitle">Invia richiesta</h3>
        <button class="close-x" type="button" id="closeContact">×</button>
      </header>
      <form id="contactForm" novalidate>
        <!-- honeypot anti-bot -->
        <input type="text" name="hp" class="visually-hidden" tabindex="-1" autocomplete="off">
        <div class="grid">
          <div class="field">
            <label for="nome">Nome *</label>
            <input id="nome" name="nome" required autocomplete="given-name" />
          </div>
          <div class="field">
            <label for="cognome">Cognome *</label>
            <input id="cognome" name="cognome" required autocomplete="family-name" />
          </div>
          <div class="field">
            <label for="societa">Società (facoltativo)</label>
            <input id="societa" name="societa" autocomplete="organization" />
          </div>
          <div class="field">
            <label for="email">Email *</label>
            <input id="email" name="email" type="email" required autocomplete="email" inputmode="email" />
          </div>
          <div class="field">
            <label for="telefono">Telefono *</label>
            <input id="telefono" name="telefono" required autocomplete="tel" inputmode="tel" />
          </div>
          <div class="field" style="grid-column:1 / -1;">
            <label for="messaggio">Richiesta *</label>
            <textarea id="messaggio" name="messaggio" required placeholder="Scrivi qui la tua richiesta…"></textarea>
            <div class="hint">I campi contrassegnati con * sono obbligatori.</div>
          </div>
        </div>
        <div class="actions">
          <button class="btn" type="button" id="cancelContact">Annulla</button>
          <button class="btn primary" type="submit" id="sendContact">Invia</button>
        </div>
        <div class="hint" id="formHint"></div>
      </form>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <script>
  (function(){
    const API_BASE = "https://api.thewinecaveau.com";
    const ENDPOINT = API_BASE + "/availability";
    const CONTACT_ENDPOINT = API_BASE + "/contact/request";

    const LOW_STOCK_THRESHOLD = 6;
    const AUTO_REFRESH_MS = 30000;
    const pageSize = ()=> (matchMedia("(max-width:640px)").matches ? 20 : 50);

    let data = [], page = 0, sort = {by:"produttore",dir:"asc"};
    const $ = id=>document.getElementById(id);
    let rows, pagination;

    const labels = {
      produttore:"Produttore", etichetta:"Etichetta", annata:"Annata",
      formato:"Formato", quantita:"Quantità", prezzo:"Prezzo", riservato:"Riservato"
    };

    /* ----- Helpers Quantità & Prezzo ----- */
    function fmtInt(n){ return Intl.NumberFormat("it-IT").format(n); }

    function normalizeQty(raw){
      const s=(raw??"").toString().trim();
      if(!s) return "";
      if(/^su\s*richiesta$/i.test(s)) return "Su richiesta";
      if(/^(nan|null|none)$/i.test(s)) return "Su richiesta";
      return s;
    }
    function qtyNumber(raw){
      const s=normalizeQty(raw);
      const n=Number(s.replace(",","."));
      return Number.isFinite(n)?n:null;
    }
    function formatQuantita(raw){
      const s=normalizeQty(raw);
      if(!s) return "—";
      const n=Number(s.replace(",","."));
      return Number.isFinite(n)?String(n):s;
    }

    function parsePrice(v){
      if (v===null || v===undefined || v==="") return null;
      const n=Number(String(v).replace(",","."));
      return Number.isFinite(n)?n:null;
    }
    function formatEUR(v){
      const n=parsePrice(v);
      if(n===null) return "—";
      try{
        return new Intl.NumberFormat("it-IT",{style:"currency",currency:"EUR"}).format(n);
      }catch{ return String(v); }
    }

    /* ----- Filtri, ordinamenti, paginazione ----- */
    function applyFilters(src){
      const q=$("q").value.trim().toLowerCase(),p=$("produttore").value,f=$("formato").value;
      const showReserved=$("riservato").value==="yes";
      return src.filter(r=>{
        if(!showReserved&&r.riservato==="YES")return false;
        if(p&&r.produttore!==p)return false;
        if(f&&r.formato!==f)return false;
        if(q && !((r.produttore+" "+r.etichetta+" "+(r.annata??"")).toLowerCase().includes(q)))return false;
        return true;
      });
    }

    function sortData(arr){
      const {by,dir}=sort;
      const s=[...arr].sort((a,b)=>{
        if(by==="quantità"){
          const na=qtyNumber(a["quantità"]??a.quantita), nb=qtyNumber(b["quantità"]??b.quantita);
          if(na===null&&nb===null){
            const sa=normalizeQty(a["quantità"]??a.quantita).toLowerCase();
            const sb=normalizeQty(b["quantità"]??b.quantita).toLowerCase();
            if(sa<sb)return-1;if(sa>sb)return 1;return 0;
          }
          if(na===null)return 1; if(nb===null)return -1; return na-nb;
        }
        if(by==="prezzo"){
          const pa=parsePrice(a.prezzo), pb=parsePrice(b.prezzo);
          if(pa===null && pb===null) return 0;
          if(pa===null) return 1;
          if(pb===null) return -1;
          return pa - pb;
        }
        if(by==="annata"){
          const aa = Number(a.annata), bb = Number(b.annata);
          if(Number.isFinite(aa) && Number.isFinite(bb)) return aa - bb;
          const sa=(a.annata??"").toString().toLowerCase();
          const sb=(b.annata??"").toString().toLowerCase();
          if(sa<sb)return-1;if(sa>sb)return 1;return 0;
        }
        const va=(a[by]??"").toString().toLowerCase();
        const vb=(b[by]??"").toString().toLowerCase();
        if(va<vb)return-1;if(va>vb)return 1;return 0;
      });
      return dir==="asc"?s:s.reverse();
    }

    function buildPagination(total,current){
      const totalPages=Math.max(1,Math.ceil(total/pageSize()));
      const btn=(label,target,disabled=false,active=false)=>`<button class="pager ${disabled?'disabled':''} ${active?'active':''}" data-page="${target}" ${disabled?'disabled':''}>${label}</button>`;
      let html='';html+=btn('‹',current-1,current<=0);
      const maxButtons=7,lastIndex=totalPages-1;
      let start=Math.max(0,current-3),end=Math.min(totalPages,start+maxButtons);
      if(end-start<maxButtons)start=Math.max(0,end-maxButtons);
      if(start>0){html+=btn('1',0,false,current===0);if(start>1)html+='<span class="dots">…</span>';}
      for(let i=start;i<end;i++){html+=btn(String(i+1),i,false,current===i);}
      if(end<totalPages){if(end<totalPages-1)html+='<span class="dots">…</span>';html+=btn(String(totalPages),lastIndex,false,current===lastIndex);}
      html+=btn('›',current+1,current>=lastIndex);
      $("pagination").innerHTML=html;
    }

    function paginate(arr){const start=page*pageSize();return arr.slice(start,start+pageSize());}
    function clampPage(total){const totalPages=Math.max(1,Math.ceil(total/pageSize()));if(page>=totalPages)page=totalPages-1;if(page<0)page=0;}

    /* ----- Rendering ----- */
    function render(){
      const filtered=applyFilters(data),sorted=sortData(filtered);
      clampPage(sorted.length);const pageData=paginate(sorted);

      rows.innerHTML='';
      if(pageData.length===0){
        rows.innerHTML='<tr><td colspan="7" class="empty">Nessun risultato</td></tr>';
      }else{
        for(const r of pageData){
          const qRaw=r["quantità"]??r.quantita, qNum=qtyNumber(qRaw), qTxt=formatQuantita(qRaw), low=qNum!==null&&qNum<=LOW_STOCK_THRESHOLD;
          rows.insertAdjacentHTML('beforeend',`
            <tr>
              <td data-th="${labels.produttore}">${r.produttore}</td>
              <td data-th="${labels.etichetta}">${r.etichetta}</td>
              <td data-th="${labels.annata}">${r.annata ?? ""}</td>
              <td data-th="${labels.formato}">${r.formato??''}</td>
              <td data-th="${labels.quantita}"><span class="qty-badge ${low?'qty-low':''}">${qTxt}</span></td>
              <td data-th="${labels.prezzo}" class="price">${formatEUR(r.prezzo)}</td>
              <td data-th="${labels.riservato}">${r.riservato==='YES'?'<span class="badge yes">YES</span>':'<span class="badge no">NO</span>'}</td>
            </tr>`);
        }
      }
      const total=filtered.length,from=total?(page*pageSize()+1):0,to=Math.min((page+1)*pageSize(),total);
      $("status").textContent = total ? `${from}–${to} di ${fmtInt(total)} risultati` : '0 risultati';
      buildPagination(total,page);
    }

    function unique(list,key){const set=new Set(list.map(x=>x[key]).filter(Boolean));return Array.from(set).sort();}
    function populateFilters(){
      const ps=unique(data,'produttore'),fs=unique(data,'formato');
      $("produttore").innerHTML='<option value="">Tutti</option>'+ps.map(x=>`<option>${x}</option>`).join('');
      $("formato").innerHTML   ='<option value="">Tutti</option>'+fs.map(x=>`<option>${x}</option>`).join('');
    }

    function keyOf(r){return [r.produttore,r.etichetta,r.formato,r.annata??""].join('||');}

    /* ----- Data fetching ----- */
    async function initialLoad(){
      rows.innerHTML = '<tr><td colspan="7" class="empty">Caricamento…</td></tr>';
      const showReserved=$("riservato").value==="yes";
      const params=new URLSearchParams(); if(showReserved) params.set("include_reserved","true");
      const url=ENDPOINT+(params.toString()?'?'+params.toString():'');
      const r=await fetch(url,{cache:'no-store'}); if(!r.ok) throw new Error('HTTP '+r.status);
      data=await r.json();
      populateFilters(); render();
    }

    // refresh leggero: aggiorna quantità e prezzo se cambiano
    async function updateShallow(){
      try{
        const showReserved=$("riservato").value==="yes";
        const params=new URLSearchParams(); if(showReserved) params.set("include_reserved","true");
        const url=ENDPOINT+(params.toString()?'?'+params.toString():'');
        const r=await fetch(url,{cache:'no-store'}); if(!r.ok) throw new Error('HTTP '+r.status);
        const latest=await r.json();
        const map=new Map(latest.map(x=>[keyOf(x), {q:x["quantità"]??x.quantita, p:x.prezzo}]));
        let changed=false;
        for(const row of data){
          const k=keyOf(row);
          if(map.has(k)){
            const {q:newQ, p:newP}=map.get(k);
            const oldQ=row["quantità"]??row.quantita;
            if(String(newQ)!==String(oldQ)){ if("quantità" in row) row["quantità"]=newQ; else row.quantita=newQ; changed=true; }
            if(String(newP)!==String(row.prezzo)){ row.prezzo=newP; changed=true; }
          }
        }
        if(changed) render();
      }catch(e){ console.warn("Auto-refresh fallito:", e.message); }
    }

    /* ----- UI wiring ----- */
    function wireUI(){
      $("q").addEventListener("input", ()=>{ page=0; render(); });
      $("produttore").addEventListener("change", ()=>{ page=0; render(); });
      $("formato").addEventListener("change", ()=>{ page=0; render(); });
      $("riservato").addEventListener("change", ()=>{ initialLoad(); });

      // Sort click
      document.querySelectorAll("th[data-sort]").forEach(th=>{
        th.style.cursor='pointer';
        th.addEventListener("click",()=>{
          const by=th.getAttribute("data-sort");
          if(sort.by===by){ sort.dir = (sort.dir==='asc'?'desc':'asc'); }
          else { sort.by=by; sort.dir='asc'; }
          page=0; render();
        });
      });

      // Pagination
      $("pagination").addEventListener("click",(e)=>{
        const btn=e.target.closest("button[data-page]"); if(!btn||btn.disabled) return;
        const target=parseInt(btn.dataset.page,10);
        if(Number.isFinite(target)){ page=target; render(); window.scrollTo({top:0,behavior:'smooth'}); }
      });

      matchMedia("(max-width:640px)").addEventListener("change", ()=>{ page=0; render(); });

      // Modal contatti
      const modal=$("contactModal");
      $("openContactBtn").addEventListener("click", ()=>{ modal.style.display="flex"; setTimeout(()=>{$("nome").focus();},50); });
      function closeModal(){ modal.style.display="none"; $("contactForm").reset(); $("formHint").textContent=''; }
      $("closeContact").addEventListener("click", closeModal);
      $("cancelContact").addEventListener("click", closeModal);

      $("contactForm").addEventListener("submit", async (ev)=>{
        ev.preventDefault();
        const f=ev.target;
        const payload={
          nome: f.nome.value.trim(),
          cognome: f.cognome.value.trim(),
          societa: f.societa.value.trim() || null,
          email: f.email.value.trim(),
          telefono: f.telefono.value.trim(),
          richiesta: f.messaggio.value.trim(),
          hp: f.hp.value.trim()
        };
        if (payload.hp){ return; }
        if (!payload.nome || !payload.cognome || !payload.email || !payload.telefono || !payload.richiesta){
          $("formHint").innerHTML = '<span class="err">Compila tutti i campi obbligatori.</span>';
          return;
        }
        $("sendContact").disabled=true; $("sendContact").textContent="Invio…";
        try{
          const res=await fetch(CONTACT_ENDPOINT,{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify(payload),
            cache:"no-store",
          });
          if(!res.ok){
            const txt = await res.text().catch(()=> "");
            throw new Error(`HTTP ${res.status} ${txt}`);
          }
          closeModal();
          showToast("Richiesta inviata. Ti risponderemo a breve.", 'success');
        }catch(e){
          $("formHint").innerHTML = '<span class="err">Invio non riuscito. Riprova più tardi.</span>';
          console.error("Contact error:", e);
          showToast("Invio non riuscito. Riprova più tardi.", 'error');
        }finally{
          $("sendContact").disabled=false; $("sendContact").textContent="Invia";
        }
      });

      // Pulsante Admin (inattivo)
      const adminBtn = $("adminBtn");
      if (adminBtn){
        adminBtn.addEventListener("click", () => {
          showToast("Funzione Admin non ancora disponibile.", "success");
        });
      }
    }

    function showToast(msg,type='success'){
      const t=$("toast");
      t.textContent=msg; t.className='toast ' + (type==='error'?'error':'success');
      t.style.display="block";
      setTimeout(()=>{ t.style.display="none"; }, 3000);
    }

    function init(){
      rows=$("rows"); pagination=$("pagination");
      wireUI();
      initialLoad().catch(e=>{
        rows.innerHTML=`<tr><td colspan="7" class="empty">Errore di caricamento. Verifica connessione o riprova.</td></tr>`;
        console.error("Errore initialLoad:", e);
        showToast("Errore di caricamento dati", 'error');
      });
      setInterval(updateShallow, AUTO_REFRESH_MS);
    }

    if(document.readyState==="loading"){ document.addEventListener("DOMContentLoaded", init, {once:true}); }
    else { init(); }
  })();
  </script>
</body>
</html>
